{% extends "admin/base_site.html" %}
{% block coltype %}col-12{% endblock %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard | CareerPath Admin{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
  
  /* --- Bảng màu & Biến toàn cục (ĐÃ CẬP NHẬT) --- */
  :root {
    /* Bảng màu mới theo yêu cầu của bạn */
    --primary: #28a745;        /* Màu Xanh lá chính */
    --warning: #edb80aff;        /* Màu Vàng nhấn */
    
    /* Màu bổ sung để hoàn thiện bảng màu 4 thẻ */
    --info: #1a6ce7ea;           /* Màu Xanh dương chuyên nghiệp (Bootstrap Blue) */
    --success: #14b8a6;        /* Màu Xanh mòng két (Teal) cho mục thành công phụ */

    /* Tông màu Graphite & Nền */
    --text-heading: #1e293b;
    --text-body: #475569;
    --bg-page: #f8fafc;
    --border-color: #e2e8f0;

    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    --card-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
  }

  /* --- Thiết lập chung --- */
  #content {
    background-color: var(--bg-page) !important;
  }
  .content-wrapper .content {
    padding: 1.5rem 2rem 2rem 2rem !important;
  }

  /* --- Tiêu đề trang ấn tượng --- */
  .page-header {
    margin-bottom: 2.5rem;
  }
  .page-header h1 {
    font-size: 2.25rem;
    font-weight: 800;
    /* Hiệu ứng Gradient sẽ tự động cập nhật theo màu mới */
    background: linear-gradient(45deg, var(--primary), var(--success));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-fill-color: transparent;
  }
  .page-header .lead {
    font-size: 1.1rem;
    color: var(--text-body);
    margin-top: 0.25rem;
    max-width: 700px;
  }

  /* === KPI STAT CARDS (GIỮ NGUYÊN STYLE NỀN ĐẬM) === */
  .stat-card {
    background-color: var(--card-color); 
    border-radius: 0.75rem;
    border: 1px solid transparent; 
    box-shadow: var(--card-shadow);
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease, filter 0.3s ease;
    height: 100%;
    color: white; 
  }
  .stat-card:hover {
    transform: translateY(-6px);
    box-shadow: var(--card-shadow-lg);
    filter: brightness(1.1);
  }

  .stat-card .inner {
    display: flex;
    align-items: center;
  }

  .stat-card .icon {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    margin-right: 1.25rem;
    background-color: rgba(0, 0, 0, 0.15);
    color: white;
  }

  .stat-card .info h3 {
    font-size: 2.1rem;
    font-weight: 700;
    margin: 0 0 0.1rem 0;
    color: #fff;
  }
  .stat-card .info p {
    font-size: 0.95rem;
    opacity: 0.85; 
    margin: 0;
    color: #fff;
  }
  
  /* Gán màu cho từng loại card */
  .stat-card.primary { --card-color: var(--primary); } /* Sẽ là màu Xanh lá mới */
  .stat-card.info    { --card-color: var(--info); }    /* Sẽ là màu Xanh dương */
  .stat-card.success { --card-color: var(--success); } /* Sẽ là màu Xanh mòng két */
  .stat-card.warning { --card-color: var(--warning); } /* Sẽ là màu Vàng mới */
  
  /* --- Card cho Biểu đồ (Không thay đổi) --- */
  .card {
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
    background-color: #fff;
    height: 100%;
  }
  .card-header {
    background-color: transparent;
    border-bottom: 1px solid var(--border-color);
    padding: 1rem 1.5rem;
  }
  .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-heading);
  }
  .card-header .fas {
    color: var(--primary); /* Sẽ là màu Xanh lá mới */
  }
  .card-body {
    padding: 1.5rem;
  }
  /* Giữ 4 card Premium trong 1 hàng và cao đều */
.kpi-premium-row > [class*="col-"] { display: flex; }
.kpi-premium-row .stat-card { width: 100%; }
  
  /* Card gọn: không ép cao bằng cột bên cạnh */
.card--auto { height: auto !important; }
.card--auto .card-body { padding-top: 1rem; padding-bottom: 1rem; }

/* Hàng kênh: căn hàng đẹp */
.channel-row .channel-item { display:flex; align-items:center; gap:12px; }
.channel-row .channel-amount { font-weight:700; color:var(--text-heading); }

/* Lưới 2 cột: trái 1 card, phải xếp dọc 2 card */
.charts-grid .stack-col { display: flex; flex-direction: column; gap: 1rem; }
.card--auto { height: auto !important; }              /* card gọn cho Doanh thu */
.card--grow { flex: 1 1 auto; }                        /* card nở chiếm phần còn lại */
.card--h380 { height: 380px; }                         /* chiều cao donut */
.card--h320 { height: 320px; }                         /* chiều cao bar premium */


</style>
{% endblock %}

{% block content %}
<div class="content-header">
  <div class="container-fluid">
    <div class="page-header">
      <h1>Dashboard</h1>

    </div>
  </div>
</div>

<div class="content">
    <!-- Hàng 1: 4 KPI Cards (HTML không đổi) -->
    <div class="row">
      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        {# Card này sẽ có màu Xanh Lá --primary #}
        <div class="stat-card primary"> 
          <div class="inner">
            <div class="icon"><i class="fas fa-users"></i></div>
            <div class="info">
              <h3>{{ total_users|intcomma }}</h3>
              <p>Tổng Người Dùng</p>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        {# Card này sẽ có màu Xanh Dương --info #}
        <div class="stat-card info">
          <div class="inner">
            <div class="icon"><i class="fas fa-user-plus"></i></div>
            <div class="info">
              <h3>+{{ signups_7d|intcomma }}</h3>
              <p>Đăng ký mới (7 ngày)</p>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        {# Card này sẽ có màu Xanh Mòng Két --success #}
        <div class="stat-card success">
          <div class="inner">
            <div class="icon"><i class="fas fa-check-circle"></i></div>
            <div class="info">
              <h3>{{ quiz_users|intcomma }}</h3>
              <p>Đã Làm Quiz ({{ quiz_rate }}%)</p>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        {# Card này sẽ có màu Vàng --warning #}
        <div class="stat-card warning">
          <div class="inner">
            <div class="icon"><i class="fas fa-user-shield"></i></div>
            <div class="info">
              <h3>{{ admin_count|intcomma }}</h3>
              <p>Tài Khoản Admin</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hàng 2: Biểu đồ (Không thay đổi) -->
    <div class="row">
      <div class="col-lg-8 mb-4">
        <div class="card">
          <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-bar mr-2"></i>Đăng ký 7 ngày gần đây</h3></div>
          <div class="card-body">
            <div style="height: 350px;"><canvas id="signup7Chart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="col-lg-4 mb-4">
        <div class="card">
          <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-pie mr-2"></i>Phân bổ người dùng làm Quiz</h3></div>
          <div class="card-body">
            <div style="height: 350px;"><canvas id="quizRateChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>


    <!-- Hàng KPI Premium -->
    <!-- Hàng KPI Premium (4 ô – cùng một hàng, cao đều) -->
    <div class="row kpi-premium-row">
      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        <div class="stat-card primary">
          <div class="inner">
            <div class="icon"><i class="fas fa-crown"></i></div>
            <div class="info">
              <h3>{{ premium_active|intcomma }}</h3>
              <p>Premium đang hoạt động</p>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        <div class="stat-card info">
          <div class="inner">
            <div class="icon"><i class="fas fa-bolt"></i></div>
            <div class="info">
              <h3>+{{ premium_activations_7d|intcomma }}</h3>
              <p>Kích hoạt Premium (7 ngày)</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 2 ô mới nằm TRONG cùng .row -->
      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        <div class="stat-card warning">
          <div class="inner">
            <div class="icon"><i class="fas fa-coins"></i></div>
            <div class="info">
              <h3>{{ revenue_month|intcomma }} VND</h3>
              <p>Doanh thu tháng này</p>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-3 mb-4">
        <div class="stat-card success">
          <div class="inner">
            <div class="icon"><i class="fas fa-shopping-bag"></i></div>
            <div class="info">
              <h3>{{ total_orders_month|intcomma }}</h3>
              <p>Tổng đơn hàng tháng này</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Khối Premium Charts (lưới 2 cột) -->
    <div class="row charts-grid">
      <!-- Cột trái: Donut to, 380px -->
      <div class="col-lg-7 mb-4">
        <div class="card card--h380">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-chart-pie mr-2"></i>Trạng thái đơn hàng</h3>
          </div>
          <div class="card-body">
            <div style="height: 100%; position:relative;">
              <canvas id="orderStatusChart"></canvas>
              <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;pointer-events:none;">
                <div style="font-size:2rem;font-weight:800;color:var(--text-heading);">
                  {{ total_orders_month|intcomma }}
                </div>
                <div style="color:var(--text-body);">Tổng đơn hàng</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cột phải: xếp dọc Doanh thu (gọn) + Bar Premium (grow) -->
      <div class="col-lg-5 mb-4 stack-col">
        <!-- Doanh thu: gọn -->
        <div class="card card--auto">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-credit-card mr-2"></i>Doanh thu</h3>
          </div>
          <div class="card-body">
            {% for ch in payment_channels %}
              <div class="d-flex align-items-center mb-2" style="gap:12px;">
                <img src="{% static 'admin/img/icon-yes.svg' %}" width="24" height="24" alt="">
                <div class="flex-grow-1" style="font-weight:600;color:var(--text-heading);">
                  {{ ch.name }}
                </div>
                <div style="font-weight:700;color:var(--text-heading);">
                  {{ ch.amount|intcomma }} VND
                </div>
              </div>
            {% empty %}
              <div>Chưa có doanh thu.</div>
            {% endfor %}
          </div>
        </div>

        <!-- Phân bổ gói Premium: chiếm phần còn lại -->
        <div class="card card--grow card--h320">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-layer-group mr-2"></i>Phân bổ gói Premium (theo lần mua gần nhất)</h3>
          </div>
          <div class="card-body">
            <div style="height: 100%;"><canvas id="planDistChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>



</div>

{# Javascript sẽ tự động cập nhật màu từ CSS, không cần thay đổi #}
<!-- Dùng UMD build để tránh xung đột -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const style = getComputedStyle(document.body);
  const get = (k, fb) => (style.getPropertyValue(k).trim() || fb);

  const chartColors = {
    primary:    get('--primary', '#28a745'),
    success:    get('--success', '#14b8a6'),
    info:       get('--info', '#1a6ce7'),
    warning:    get('--warning', '#edb80a'),
    textBody:   get('--text-body', '#475569'),
    borderColor:get('--border-color', '#e2e8f0'),
    textHeading:get('--text-heading', '#1e293b'),
    bgPage:     get('--bg-page', '#ffffff')
  };

  Chart.defaults.font.family = "system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif";
  Chart.defaults.color = chartColors.textBody;
  if (Chart.defaults.plugins?.legend?.labels) {
    Chart.defaults.plugins.legend.labels.boxWidth = 12;
    Chart.defaults.plugins.legend.labels.padding = 20;
  }

  // Lấy dữ liệu JSON từ view
  const labels7        = JSON.parse('{{ labels_7_json|escapejs }}');
  const signupsSeries7 = JSON.parse('{{ signups_series_7_json|escapejs }}');
  const quizLabels     = JSON.parse('{{ quiz_labels_json|escapejs }}');
  const quizValues     = JSON.parse('{{ quiz_values_json|escapejs }}');

  // ---- Line chart ----
  const lineEl = document.getElementById('signup7Chart');
  if (lineEl) {
    const ctx = lineEl.getContext('2d');
    const grad = ctx.createLinearGradient(0,0,0,350);
    if (chartColors.primary.startsWith('#')) {
      grad.addColorStop(0, `${chartColors.primary}B3`);  // <-- backtick
      grad.addColorStop(1, `${chartColors.primary}00`);
    } else {
      grad.addColorStop(0, 'rgba(40,167,69,0.7)');
      grad.addColorStop(1, 'rgba(40,167,69,0)');
    }

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels7,
        datasets: [{
          label: 'Đăng ký',
          data: signupsSeries7,
          fill: true,
          backgroundColor: grad,
          borderColor: chartColors.primary,
          borderWidth: 2,
          tension: 0.4,
          pointBackgroundColor: chartColors.primary,
          pointRadius: 5,
          pointHoverRadius: 7,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: chartColors.textHeading,
            titleFont: { weight: 'bold' },
            bodyFont: { size: 13 },
            padding: 12,
            cornerRadius: 8,
            displayColors: false,
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: chartColors.borderColor, borderDash: [2,4], drawBorder: false } },
          x: { grid: { display: false } }
        }
      }
    });
  }

  // ---- Doughnut chart ----
  const pieEl = document.getElementById('quizRateChart');
  if (pieEl) {
    const pctx = pieEl.getContext('2d');
    new Chart(pctx, {
      type: 'doughnut',
      data: {
        labels: quizLabels,
        datasets: [{
          data: quizValues,
          backgroundColor: [ chartColors.success, chartColors.info, chartColors.warning, '#cbd5e1' ],
          borderColor: chartColors.bgPage,
          borderWidth: 4,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '75%',
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'rectRounded' } },
          tooltip: {
            backgroundColor: chartColors.textHeading,
            padding: 12,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed;
                const total = context.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                const percentage = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                return ` ${label}: ${value} (${percentage}%)`;   // <-- backtick
              }
            }
          }
        }
      }
    });
  }

  // Lấy dữ liệu gói từ context
  const planLabels = JSON.parse('{{ plan_labels_json|escapejs }}');
  const planValues = JSON.parse('{{ plan_values_json|escapejs }}');

  // ---- Bar chart: phân bổ gói Premium (latest per user) ----
  const planEl = document.getElementById('planDistChart');
  if (planEl) {
    const pctx2 = planEl.getContext('2d');
    new Chart(pctx2, {
      type: 'bar',
      data: {
        labels: planLabels,
        datasets: [{
          label: 'Số người dùng',
          data: planValues,
          borderColor: chartColors.info,
          backgroundColor: chartColors.info,
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: chartColors.textHeading,
            padding: 12,
            cornerRadius: 8,
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: chartColors.borderColor, borderDash: [2,4], drawBorder: false } },
          x: { grid: { display: false } }
        }
      }
    });
  }

    // ==== Donut: Trạng thái đơn hàng tháng này ====
  const orderStatusLabels = JSON.parse('{{ order_status_labels_json|escapejs }}');
  const orderStatusValues = JSON.parse('{{ order_status_values_json|escapejs }}');

  const osEl = document.getElementById('orderStatusChart');
  if (osEl) {
    const osCtx = osEl.getContext('2d');
    new Chart(osCtx, {
      type: 'doughnut',
      data: {
        labels: orderStatusLabels,
        datasets: [{
          data: orderStatusValues,
          backgroundColor: [
            chartColors.primary,  // Đã thanh toán
            chartColors.info,     // Chờ thanh toán
            chartColors.warning   // Thất bại
          ],
          borderColor: chartColors.bgPage,
          borderWidth: 4,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'rectRounded' } },
          tooltip: {
            backgroundColor: chartColors.textHeading,
            padding: 12,
            cornerRadius: 8,
            callbacks: {
              label: (ctx) => {
                const total = ctx.dataset.data.reduce((a,b)=>a+b,0) || 1;
                const v = ctx.parsed;
                const pct = Math.round((v/total)*100);
                return ` ${ctx.label}: ${v} (${pct}%)`;
              }
            }
          }
        }
      }
    });
  }

});
</script>

{% endblock %}