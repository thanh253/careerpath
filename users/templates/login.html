{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ƒêƒÉng nh·∫≠p - CareerPath</title>
    <!-- Nh√∫ng Font Awesome -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap&subset=vietnamese" rel="stylesheet">
    <!-- Link CSS m·ªõi -->
    <link rel="stylesheet" href="{% static 'css/user.css' %}">
</head>
<body class="page-login">
    <div class="loading-overlay" id="full-page-loader">
        <div class="spinner"></div>
    </div>
    <main class="login-wrapper">
        <div class="login-container">
            <!-- C·ªôt Tr√°i: Illustration -->
            <div class="login-illustration-panel">
                {# **ƒê·∫£o ng∆∞·ª£c c·∫•u tr√∫c b√™n trong** #}
                <div class="illustration-content">
                     <img src="{% static 'images/login.png' %}" alt="Minh h·ªça ƒêƒÉng nh·∫≠p" class="illustration-img"/>
                     <h2 class="illustration-title">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi <span class="brand-text">CAREERPATH</span></h2>
                     <p class="illustration-subtitle">Kh√°m ph√° ti·ªÅm nƒÉng, ƒë·ªãnh h∆∞·ªõng t∆∞∆°ng lai v√† b·ª©t ph√° s·ª± nghi·ªáp c·ªßa b·∫°n ngay h√¥m nay.</p>
                </div>
            </div>

            <!-- C·ªôt Ph·∫£i: Form ƒêƒÉng Nh·∫≠p -->
            <div class="login-form-panel">
                <h1 class="form-title">ƒêƒÉng nh·∫≠p</h1>
                
                <form method="post" novalidate>
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                        <div class="form-errors">
                            {% for error in form.non_field_errors %}
                                <p class="error-item">{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- **C·∫•u tr√∫c input m·ªõi** -->
                    <div class="floating-input-group">
                        {{ form.username }}
                        <label for="{{ form.username.id_for_label }}">{{ form.username.label }} *</label>
                        {% if form.username.errors %}
                            <small class="error-text">{{ form.username.errors.as_text | striptags }}</small>
                        {% endif %}
                    </div>
                    
                    <div class="floating-input-group password-group">
                        {{ form.password }}
                        <label for="{{ form.password.id_for_label }}">{{ form.password.label }} *</label>
                        <button type="button" class="toggle-password" aria-label="Hi·ªán/·∫®n m·∫≠t kh·∫©u">
                            <i class="fas fa-eye"></i>
                        </button>
                        {% if form.password.errors %}
                            <small class="error-text">{{ form.password.errors.as_text | striptags }}</small>
                        {% endif %}
                    </div>
                    
                    <!-- **C·∫•u tr√∫c action m·ªõi** -->
                    <div class="form-actions">
                        <div class="checkbox-group">
                            <input type="checkbox" id="remember-me" name="remember-me">
                            <label for="remember-me">Ghi nh·ªõ ƒëƒÉng nh·∫≠p</label>
                        </div>
                        <a href="#" id="forgot-password-trigger" class="action-link">Qu√™n m·∫≠t kh·∫©u?
                    </div>

                    <button type="submit" class="btn-submit">ƒêƒÉng nh·∫≠p</button>
                </form>

                <div class="or-divider"><span>Ho·∫∑c</span></div>

                <a href="{% url 'social:begin' 'google-oauth2' %}?next=/" class="google-btn">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" width="22" height="22"/>
                    <span>Ti·∫øp t·ª•c v·ªõi Google</span>
                </a>
                
                <p class="switch-form-text">
                    Ch∆∞a c√≥ t√†i kho·∫£n? <a href="{% url 'users:register' %}" class="switch-form-link">ƒêƒÉng k√Ω ngay</a>
                </p>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="password-reset-modal">
        <div class="modal-content">
            
            <!-- Overlay loading -->
            <div class="modal-loading" id="modal-loading">
                <i class="fas fa-spinner fa-spin" style="font-size:36px;color:#333;"></i>
            </div>

            <!-- VIEW 1: FORM ƒêI·ªÄN EMAIL -->
            <div id="reset-form-view">
                <div class="modal-header">
                    <h2 class="modal-title">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h2>
                </div>
                <p class="modal-description">
                    Nh·∫≠p ƒë·ªãa ch·ªâ email c·ªßa t√†i kho·∫£n, ch√∫ng t√¥i s·∫Ω g·ª≠i cho b·∫°n li√™n k·∫øt ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u.
                </p>
                
                <form method="post" action="{% url 'users:ajax_password_reset' %}" class="modal-form" id="password-reset-form" novalidate>
                    {% csrf_token %}
                    <div class="floating-input-group">
                        {{ password_reset_form.email }}
                        <label for="{{ password_reset_form.email.id_for_label }}">ƒê·ªãa ch·ªâ email *</label>
                        <div id="reset-email-error" class="error-text"></div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-cancel" id="cancel-reset-btn">H·ªßy b·ªè</button>
                        <button type="submit" class="btn btn-continue">Ti·∫øp t·ª•c</button>
                    </div>
                </form>
            </div>

        </div>
    </div>


    <!-- üëá TH√äM CONTAINER CHO TOAST V√ÄO ƒê√ÇY -->
    <div id="toast-container"></div>

    <!-- **JAVASCRIPT CHO N√öT HI·ªÜN/·∫®N M·∫¨T KH·∫®U** -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const togglePassword = document.querySelector('.toggle-password');
            const passwordInput = document.getElementById('{{ form.password.id_for_label }}');

            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function () {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    
                    this.querySelector('i').classList.toggle('fa-eye');
                    this.querySelector('i').classList.toggle('fa-eye-slash');
                });
            }

            //TH√äM JAVASCRIPT ƒê·ªÇ ƒêI·ªÄU KHI·ªÇN MODAL

            const modal = document.getElementById('password-reset-modal');
            const triggerLink = document.getElementById('forgot-password-trigger');
            const cancelButton = document.getElementById('cancel-reset-btn');
            const resetForm = document.getElementById('password-reset-form');
            const emailErrorDiv = document.getElementById('reset-email-error');
            const toastContainer = document.getElementById('toast-container');

            // --- H√ÄM TI·ªÜN √çCH ---
            
            // H√ÄM showToast ƒê√É ƒê∆Ø·ª¢C N√ÇNG C·∫§P
            function showToast(message, duration = 5000) {
                const toast = document.createElement('div');
                toast.className = 'toast';

                toast.innerHTML = `
                    <div class="toast-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#28A745"></path><path d="M9.5 11.5L11.5 13.5L14.5 10.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </div>
                    <p class="toast-message">${message}</p>
                    <button class="toast-close">√ó</button>
                    <div class="toast-progress">
                        <div class="toast-progress-bar"></div>
                    </div>
                `;
                
                toastContainer.appendChild(toast);

                // B·∫Øt ƒë·∫ßu logic Pause/Resume
                let autoCloseTimer;
                let remainingTime = duration;
                let startTime;
                const progressBar = toast.querySelector('.toast-progress-bar');

                const hideToast = () => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove(), { once: true });
                };

                const pauseTimer = () => {
                    clearTimeout(autoCloseTimer);
                    remainingTime -= (Date.now() - startTime);
                    progressBar.style.animationPlayState = 'paused';
                };

                const resumeTimer = () => {
                    startTime = Date.now();
                    progressBar.style.animationPlayState = 'running';
                    autoCloseTimer = setTimeout(hideToast, remainingTime);
                };

                toast.addEventListener('mouseenter', pauseTimer);
                toast.addEventListener('mouseleave', resumeTimer);

                toast.querySelector('.toast-close').addEventListener('click', () => {
                    clearTimeout(autoCloseTimer);
                    hideToast();
                });
                
                // Timeout nh·ªè ƒë·ªÉ k√≠ch ho·∫°t transition slide-in v√† b·∫Øt ƒë·∫ßu timer
                setTimeout(() => {
                    toast.classList.add('show');
                    resumeTimer(); // B·∫Øt ƒë·∫ßu timer l·∫ßn ƒë·∫ßu
                }, 10);
            }

            // H√†m ƒë·ªÉ ƒë√≥ng modal v√† reset form (gi·ªØ nguy√™n)
            function closeModal() {
                modal.classList.remove('active');
                setTimeout(() => {
                    resetForm.reset();
                    emailErrorDiv.textContent = '';
                }, 300);
            }

            // --- LOGIC X·ª¨ L√ù S·ª∞ KI·ªÜN (gi·ªØ nguy√™n) ---

            // M·ªü modal
            triggerLink.addEventListener('click', function(event) {
                event.preventDefault();
                modal.classList.add('active');
            });

            // ƒê√≥ng modal
            cancelButton.addEventListener('click', closeModal);
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });


            const modalLoading = document.getElementById('modal-loading');

            resetForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(resetForm);
                emailErrorDiv.textContent = '';

                // Hi·ªán overlay m·ªù + icon xoay
                modalLoading.classList.add('show');

                fetch(resetForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                .then(response => new Promise(resolve => setTimeout(() => resolve(response), 500))) // delay nh·∫π
                .then(response => {
                    if (response.ok) return response.json();
                    return response.json().then(err => Promise.reject(err));
                })
                .then(data => {
                    if (data.status === 'success') {
                        closeModal();
                        showToast(data.message || 'Vui l√≤ng ki·ªÉm tra email ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.status === 'error' && error.errors) {
                        const emailErrors = JSON.parse(error.errors).email;
                        if (emailErrors && emailErrors.length > 0) {
                            emailErrorDiv.textContent = emailErrors[0].message;
                        }
                    } else {
                        emailErrorDiv.textContent = 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.';
                    }
                })
                .finally(() => {
                    // ·∫®n overlay
                    modalLoading.classList.remove('show');
                });
            });

        });
    </script>
</body>
</html>